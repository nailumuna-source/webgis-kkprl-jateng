<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>WebGIS KKPRL Jawa Tengah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet Search -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css"/>

  <style>
    body { margin:0; padding:0; }
    #map { width:100%; height:100vh; }

    .popup-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    .popup-table td {
      border: 1px solid #ccc;
      padding: 4px;
    }
    .popup-table td:first-child {
      font-weight: bold;
      background: #f5f5f5;
      width: 35%;
    }

    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      font-size: 12px;
      border-radius: 5px;
    }
    .legend i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }
  </style>
</head>

<body>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Search -->
<script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

<script>
/* =======================
   BASEMAP
======================= */
var map = L.map("map").setView([-7.2, 110.0], 8);

var osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { attribution: "&copy; OpenStreetMap contributors" }
);

var esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles Â© Esri" }
);

osm.addTo(map);

/* =======================
   WARNA PER NAMA SUBJEK
   (TANPA BIRU & HIJAU)
======================= */
var colorPalette = [
  "#ff8c00", // oranye
  "#6a3d9a", // ungu
  "#e31a1c", // merah
  "#b15928", // coklat
  "#f781bf", // pink
  "#ffd92f", // kuning
  "#a65628", // coklat tua
  "#fb9a99"  // merah muda
];

var subjectColors = {};
var colorIndex = 0;

function getSubjectColor(nama) {
  if (!subjectColors[nama]) {
    subjectColors[nama] = colorPalette[colorIndex % colorPalette.length];
    colorIndex++;
  }
  return subjectColors[nama];
}

/* =======================
   STYLE & POPUP
======================= */
function kkprlStyle(feature) {
  return {
    color: "#333",
    weight: 1,
    fillColor: getSubjectColor(feature.properties.NAMA_SUBJ),
    fillOpacity: 0.6
  };
}

function onEachFeature(feature, layer) {
  var p = feature.properties;

  var popupContent = `
    <table class="popup-table">
      <tr><td>No KKPRL</td><td>${p.NO_KKPRL || "-"}</td></tr>
      <tr><td>Nama Subjek</td><td>${p.NAMA_SUBJ || "-"}</td></tr>
      <tr><td>Kegiatan</td><td>${p.KEGIATAN || "-"}</td></tr>
      <tr><td>Luas (Ha)</td><td>${p.LUAS_HA || "-"}</td></tr>
      <tr><td>Perairan</td><td>${p.PERAIRAN || "-"}</td></tr>
      <tr><td>Provinsi</td><td>${p.PROVINSI || "-"}</td></tr>
      <tr><td>Tanggal Terbit</td><td>${p.TERBIT || "-"}</td></tr>
      <tr><td>Berlaku</td><td>${p.BERLAKU || "-"}</td></tr>
      <tr><td>Penerbit</td><td>${p.PENERBIT || "-"}</td></tr>
    </table>
  `;

  layer.bindPopup(popupContent);
}

/* =======================
   LOAD GEOJSON
======================= */
fetch("data/kkprl_jawa.geojson")
  .then(res => res.json())
  .then(data => {

    var kkprlLayer = L.geoJSON(data, {
      style: kkprlStyle,
      onEachFeature: onEachFeature
    }).addTo(map);

    map.fitBounds(kkprlLayer.getBounds());

    /* =======================
       LAYER CONTROL
    ======================= */
    L.control.layers(
      {
        "OpenStreetMap": osm,
        "Satelit (Esri)": esriSat
      },
      {
        "KKPRL": kkprlLayer
      },
      { collapsed: false }
    ).addTo(map);

    /* =======================
       SEARCH (Nama Subjek & No KKPRL)
    ======================= */
    var searchControl = new L.Control.Search({
      layer: kkprlLayer,
      propertyName: "NAMA_SUBJ",
      initial: false,
      zoom: 12,
      marker: false
    });

    map.addControl(searchControl);

    /* =======================
       LEGEND OTOMATIS
    ======================= */
    var legend = L.control({ position: "bottomright" });

    legend.onAdd = function () {
      var div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<b>Nama Subjek KKPRL</b><br>";

      for (var key in subjectColors) {
        div.innerHTML +=
          `<i style="background:${subjectColors[key]}"></i> ${key}<br>`;
      }
      return div;
    };

    legend.addTo(map);

  })
  .catch(err => {
    console.error(err);
    alert("GeoJSON tidak bisa dimuat. Cek nama & lokasi file.");
  });
</script>
</body>
</html>
