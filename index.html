<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>WebGIS KKPRL Jawa Tengah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Search -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.4/dist/leaflet-search.min.css"/>
  <script src="https://unpkg.com/leaflet-search@3.0.4/dist/leaflet-search.min.js"></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }

    .popup-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    .popup-table td {
      border: 1px solid #ccc;
      padding: 4px;
    }
    .popup-table td:first-child {
      font-weight: bold;
      background: #f5f5f5;
      width: 35%;
    }

    .legend {
      background: white;
      padding: 8px;
      font-size: 12px;
      line-height: 18px;
      border-radius: 4px;
    }
    .legend i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 6px;
      opacity: 0.7;
    }

    .filter-box {
      background: white;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
  // =====================
  // INISIALISASI MAP
  // =====================
  var map = L.map("map").setView([-7.2, 110.0], 8);

  // =====================
  // BASEMAP
  // =====================
  var osm = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { attribution: "&copy; OpenStreetMap contributors" }
  );

  var esriSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { attribution: "Tiles Â© Esri" }
  );

  osm.addTo(map);

  // =====================
  // WARNA KEGIATAN (AMAN)
  // =====================
  function getColor(kegiatan) {
    return kegiatan === "Berusaha" ? "#ff8c00" :      // Oranye
           kegiatan === "Non Berusaha" ? "#6a3d9a" : // Ungu
           "#999999";
  }

  function kkprlStyle(feature) {
    return {
      color: "#333",
      weight: 1,
      fillColor: getColor(feature.properties.KEGIATAN),
      fillOpacity: 0.6
    };
  }

  // =====================
  // POPUP
  // =====================
  function popupKKPRL(feature, layer) {
    var p = feature.properties;
    layer.bindPopup(`
      <table class="popup-table">
        <tr><td>No KKPRL</td><td>${p.NO_KKPRL || "-"}</td></tr>
        <tr><td>Nama Subjek</td><td>${p.NAMA_SUBJ || "-"}</td></tr>
        <tr><td>Kegiatan</td><td>${p.KEGIATAN || "-"}</td></tr>
        <tr><td>Luas (Ha)</td><td>${p.LUAS_HA || "-"}</td></tr>
        <tr><td>Provinsi</td><td>${p.PROVINSI || "-"}</td></tr>
        <tr><td>Perairan</td><td>${p.PERAIRAN || "-"}</td></tr>
        <tr><td>Terbit</td><td>${p.TERBIT || "-"}</td></tr>
        <tr><td>Berlaku</td><td>${p.BERLAKU || "-"}</td></tr>
        <tr><td>Penerbit</td><td>${p.PENERBIT || "-"}</td></tr>
      </table>
    `);
  }

  var kkprlLayer;
  var kkprlData;

  // =====================
  // LOAD GEOJSON
  // =====================
  fetch("data/kkprl_jawa.geojson")
    .then(res => res.json())
    .then(data => {
      kkprlData = data;

      kkprlLayer = L.geoJSON(kkprlData, {
        style: kkprlStyle,
        onEachFeature: popupKKPRL
      }).addTo(map);

      map.fitBounds(kkprlLayer.getBounds());

      // =====================
      // LAYER CONTROL
      // =====================
      L.control.layers(
        {
          "OpenStreetMap": osm,
          "Satelit (Esri)": esriSat
        },
        {
          "KKPRL": kkprlLayer
        },
        { collapsed: false }
      ).addTo(map);

      // =====================
      // SEARCH (NO_KKPRL)
      // =====================
      map.addControl(new L.Control.Search({
        layer: kkprlLayer,
        propertyName: "NO_KKPRL",
        marker: false,
        moveToLocation: function(latlng) {
          map.setView(latlng, 14);
        }
      }));

      addLegend();
      addFilter();
    });

  // =====================
  // LEGEND
  // =====================
  function addLegend() {
    var legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      var div = L.DomUtil.create("div", "legend");
      div.innerHTML += "<b>Kegiatan KKPRL</b><br>";
      ["Berusaha", "Non Berusaha"].forEach(k => {
        div.innerHTML += `<i style="background:${getColor(k)}"></i>${k}<br>`;
      });
      return div;
    };
    legend.addTo(map);
  }

  // =====================
  // FILTER
  // =====================
  function addFilter() {
    var filter = L.control({ position: "topright" });

    filter.onAdd = function () {
      var div = L.DomUtil.create("div", "filter-box");
      div.innerHTML = `
        <b>Filter Kegiatan</b><br>
        <select id="filterKegiatan">
          <option value="all">Semua</option>
          <option value="Berusaha">Berusaha</option>
          <option value="Non Berusaha">Non Berusaha</option>
        </select>
      `;
      return div;
    };

    filter.addTo(map);

    document.getElementById("filterKegiatan").addEventListener("change", function () {
      var val = this.value;
      kkprlLayer.clearLayers();

      if (val === "all") {
        kkprlLayer.addData(kkprlData);
      } else {
        kkprlLayer.addData({
          type: "FeatureCollection",
          features: kkprlData.features.filter(
            f => f.properties.KEGIATAN === val
          )
        });
      }
    });
  }
</script>
</body>
</html>
